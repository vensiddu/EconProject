---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

The librarys that we are loading in.

```{r}
Packages <- c("ggplot2", "dplyr", "stargazer", "randomForest", "nnet", "caret")
lapply(Packages, library, character.only = TRUE)

```
Data import
```{r}
wind_turbine_data <- read.csv("uswtdb_v6_0_20230531.csv")
wind_ordinance_data <- read.csv("wind_ordinance_main.csv")
wind_resource_data <- read.csv("wtk_site_metadata.csv")
states <- read.csv("states.csv")
county_complete <- read.csv("county_complete.csv")
```
clean and group wind_resource_data
```{r}
wind_resource_data <- wind_resource_data[wind_resource_data$County != "Unknown", ]
wind_resource_data <- wind_resource_data[wind_resource_data$State != "Unknown", ]
wind_resource_data <- wind_resource_data %>%
  group_by(State, County) %>%
  summarise(across(c(fraction_of_usable_area, capacity, wind_speed, capacity_factor), mean), .groups = 'drop')
```
Clean wind turbine data
```{r}
wind_turbine_main <- wind_turbine_data[complete.cases(wind_turbine_data[, c("eia_id", "p_year", "p_cap", "t_manu", "t_model", "t_cap", "t_hh", "t_rd", "xlong", "ylat")]),]
wind_turbine_main <- wind_turbine_main[which(wind_turbine_main$p_year >= 2001),]
wind_turbine_main <- wind_turbine_main[which(!wind_turbine_main$t_state %in% c("AK", "HI")),]
wind_turbine_main$t_cap <- wind_turbine_main$t_cap/1000
wind_turbine_main$t_county <- gsub(' County', "", wind_turbine_main$t_county)
```
This is how to get the mode in factoral data
```{r}
calculate_mode <- function(x) {
  uniq_x <- unique(x)
  uniq_x[which.max(tabulate(match(x, uniq_x)))]
}
```

Wind ordinance data cleaning
```{r}
wind_ordinance_data$X <- NULL
wind_ordinance_main <- wind_ordinance_data[which(wind_ordinance_data$ordinance_year >= 2001),]
ordinance_State <- wind_ordinance_main %>% dplyr::group_by(State) %>% dplyr::summarise(tot_ord = n())
wind_ordinance_main$ordinance <- 1 
wind_resource_data <- wind_resource_data[which(!wind_resource_data$State %in% c("Alaska", "Hawaii")),]
```
County Complete geting Aera
```{r}
Area <- select(county_complete, state, name, area_2010)
Area$name <- gsub(' County', "", Area$name)
```
 Merging the datasets
```{r}
wind_ordinance_main <- merge(wind_ordinance_main, states, by.x = c("State"), by.y = c("State"), all.x = T)
Area_Final <- merge(Area, states, by.x = "state", by.y = "State", all.x = T)
wind_resource_Final <- merge(wind_resource_data, states, by.x = c("State"), by.y = c("State"), all.x = T)
turbine_ordinance_merge <- merge(wind_turbine_main, wind_ordinance_main, by.x = c("t_state", "t_county"), by.y = c("Abbreviation", "County"), all.x=T)
```
 More merging
```{r}
turbine_ordinance_merge$ordinance[is.na(turbine_ordinance_merge$ordinance)] <- 0
turbine_ordinance_merge$State <- NULL

turbine_ordinance_merge <- subset(turbine_ordinance_merge, select = -c(ordinance_year))
turbine_ordinance_merge <- subset(turbine_ordinance_merge, select = -c(case_id,faa_ors,faa_asn))
turbine_ordinance_merge <- subset(turbine_ordinance_merge, select = -c(usgs_pr_id,eia_id, t_fips))
turbine_ordinance_merge <- subset(turbine_ordinance_merge, select = -c(p_name,retrofit, retrofit_year,t_img_date,t_img_srce,xlong,ylat))
```

group By State
```{r}
turbine_ordinance_county <- turbine_ordinance_merge %>% dplyr::group_by(t_state, t_county) %>% dplyr::summarise(tot_cap = sum(t_cap), avg_p_cap = mean(p_cap),avg_hh = mean(t_hh),avg_rd = mean(t_rd),ordinance = mean(ordinance),t_manu = calculate_mode(t_manu), turbines = n(),
t_model = calculate_mode(t_model),t_rsa = mean(t_rsa),t_ttlh  = mean(t_ttlh),
avg_t_cap = mean(t_cap))
```
More merging
```{r}
# Remove the "State" column from wind_resource_Final
wind_resource_Final <- wind_resource_Final[, !(names(wind_resource_Final) %in% "State")]

# Merge the datasets using Abbreviation and t_state
merged_data <- merge(turbine_ordinance_county, wind_resource_Final, by.x = c("t_state", "t_county"), by.y = c("Abbreviation", "County"))

Area_Final <- Area_Final[, !(names(Area_Final) %in% "state")]

merged_data <- merge(merged_data, Area_Final, by.x = c("t_state", "t_county"), by.y = c("Abbreviation", "name"))

```

Random Forest-data split
```{r}
# Split the dataset into training and testing sets
set.seed(123)  # for reproducibility
train_indices <- sample(1:nrow(merged_data), 0.7 * nrow(merged_data))  # 70% for training
train_data <- merged_data[train_indices, ]
test_data <- merged_data[-train_indices, ]
```

More Random Forest- Cross-Validation
```{r}
# Set seed for reproducibility
set.seed(123)

# Split data into training and testing datasets
index <- createDataPartition(y = merged_data$tot_cap, p = 0.8, list = FALSE)
training_data <- merged_data[index, ]
test_data <- merged_data[-index, ]

# Initialize variables to store results
best_model <- NULL
best_mse <- Inf
```
Loop-- Cross-Validation
```{r}
# Run the model 50 times
for (i in 1:50) {
  # Prepare the data
  predictors <- training_data[, !names(training_data) %in% c("tot_cap")]
  response <- training_data$tot_cap

  # Set up cross-validation
  ctrl <- trainControl(method = "cv",    # Cross-validation method
                       number = 5,       # Number of folds
                       repeats = 3)      # Number of repetitions

  # Train the random forest model
  model <- train(x = predictors,       # Predictor variables
                 y = response,         # Response variable
                 method = "rf",        # Random forest method
                 trControl = ctrl)     # Cross-validation control

  # Make predictions on the test dataset
  predictions <- predict(model, newdata = test_data)

  # Calculate Mean Squared Error (MSE)
  mse <- mean((predictions - test_data$tot_cap)^2)

  # Check if this model is better than the previous best model
  if (mse < best_mse) {
    best_model <- model
    best_mse <- mse
  }
  # Print MSE for each iteration
  cat("Iteration", i, "- MSE:", mse, "\n")
}

```
Results-- Cross-Validation
```{r}
# Print the best model
print(best_model)

# Print the best MSE
print(paste("Best Mean Squared Error:", best_mse))
```
```{r}
options(scipen = 999)
predictions <- predict(best_model, newdata = test_data)
mse <- mean((predictions - test_data$tot_cap)^2)
print(paste("Mean Squared Error (MSE):", mse))
se = (predictions - test_data$tot_cap)^2
prediction_table <- data.frame(Real = test_data$tot_cap, Predicted = predictions,
                               SE = se, State = test_data$t_state,County = test_data$t_county)
print(prediction_table)
```


