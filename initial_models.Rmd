---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

The librarys that we are loading in.

```{r}
Packages <- c("ggplot2", "dplyr", "stargazer", "glmnet", "leaps", "e1071", "collapse")
lapply(Packages, library, character.only = TRUE)
```

```{r}
###  1. Wind turbine data
wind_turbine_data <- read.csv("uswtdb_v6_0_20230531.csv")
wind_turbine_main <- wind_turbine_data[complete.cases(wind_turbine_data[, c("eia_id", "p_year", "p_cap", "t_manu", "t_model", "t_cap", "t_hh", "t_rd", "xlong", "ylat")]),]
wind_turbine_main <- wind_turbine_main[which(wind_turbine_main$p_year >= 2001),]
wind_turbine_main <- wind_turbine_main[which(!wind_turbine_main$t_state %in% c("AK", "HI")),]

# convert turbine capacity in MWs
wind_turbine_main$t_cap <- wind_turbine_main$t_cap/1000


wind_project_data <- wind_turbine_main %>% dplyr::group_by(eia_id) %>% dplyr::summarise(p_cap = mean(p_cap), t_cap = mean(t_cap), operating_year = first(p_year),
                                                                                        hub_ht = mean(t_hh), rotor_diam = mean(t_rd), t_manu = first(t_manu), turbines = n(),
                                                                                        t_model = first(t_model), state = first(t_state), county = first(t_county))
wind_project_data <- as.data.frame(wind_project_data)

# 10.
wind_data_state <- wind_project_data %>% dplyr::group_by(state) %>% dplyr::summarise(tot_cap = sum(p_cap), tot_turbines = sum(turbines))


###  2. Wind ordinance data
wind_ordinance_data <- read.csv("wind_ordinance_main.csv")
wind_ordinance_data$X <- NULL

wind_ordinance_main <- wind_ordinance_data[which(wind_ordinance_data$ordinance_year >= 2001),]
ordinance_state <- wind_ordinance_main %>% dplyr::group_by(State) %>% dplyr::summarise(tot_ord = n())


# 4.
ordinance_annual <- wind_ordinance_main %>% dplyr::group_by(ordinance_year) %>% dplyr::summarise(tot_ord = n())
ordinance_annual$cummulative_ord <- cumsum(ordinance_annual$tot_ord)


### 3. Wind Resource Quality data
wind_resource_data <- read.csv("wtk_site_metadata.csv")
wind_resource_main <- wind_resource_data[which(wind_resource_data$power_curve != "offshore"),]
wind_resource_main <- wind_resource_main[which(!wind_resource_main$State %in% c("Alaska", "Hawaii")),]


# 6.
# top 5 states with highest average wind speed
wind_resource_state <- wind_resource_main %>% dplyr::group_by(State) %>% dplyr::summarise(wind_speed = mean(wind_speed), cap_factor = mean(capacity_factor))
summary_2_6 <- wind_resource_state[order(wind_resource_state$wind_speed, decreasing = T), c("State", "wind_speed")][1:5,]

# highest capacity factors
summary_2_6 <- as.data.frame(summary_2_6)
summary_2_6 <- summary_2_6 %>% cbind(wind_resource_state[order(wind_resource_state$cap_factor, decreasing = T), c("State", "cap_factor")][1:5,])

# 7. Refer to the pdf
```


```{r}
#### 4. Merging the datasets
states <- read.csv("states.csv")
wind_ordinance_main <- merge(wind_ordinance_main, states, by.x = c("State"), by.y = c("State"), all.x = T)
# create an ordinance flag
wind_ordinance_main$ordinance <- 1 

# remove the "County" string from county variable in wind turbine data
wind_turbine_main$t_county <- gsub(' County', "", wind_turbine_main$t_county)

# merging the datasets
turbine_ordinance_merge <- merge(wind_turbine_main, wind_ordinance_main, by.x = c("t_state", "t_county"), by.y = c("Abbreviation", "County"), all.x=T)

# replace NAs in ordinance flag as 0 -- these counties don't have any ordinance
turbine_ordinance_merge$ordinance[is.na(turbine_ordinance_merge$ordinance)] <- 0
turbine_ordinance_merge$State <- NULL

turbine_ordinance_merge <- subset(turbine_ordinance_merge, select = -c(ordinance_year))
turbine_ordinance_county <- turbine_ordinance_merge %>% dplyr::group_by(t_state, t_county) %>% dplyr::summarise(tot_cap = sum(p_cap),
                                                                                                                        avg_cap = mean(p_cap),
                                                                                                                        avg_hh = mean(t_hh),
                                                                                                                        avg_rd = mean(t_rd),
                                                                                                                        ordinance = mean(ordinance))
```
Regression Models
```{r}
model_1 <- lm(tot_cap ~ ordinance, data = turbine_ordinance_county)
summary(model_1)
model_2 <- lm(avg_cap ~ ordinance, data = turbine_ordinance_county)
summary(model_2)
model_3 <- lm(avg_hh ~ ordinance, data = turbine_ordinance_county)
summary(model_3)
model_4 <- lm(avg_rd ~ ordinance, data = turbine_ordinance_county)
summary(model_4)
```
Classification Models
```{r}
set.seed(0)
train <- sample(1:nrow(turbine_ordinance_county), .9*nrow(turbine_ordinance_county))
test <- (-train)  
y_test <- turbine_ordinance_county$ordinance[test]
data_train <- turbine_ordinance_county[train, ]
```
b. LPM, logit, probit
```{r}
lpm <- lm(ordinance ~ avg_cap, data =  turbine_ordinance_county[train, ])
data_train$lpm_prediction <- predict(lpm,  turbine_ordinance_county[train, ])

logit <- glm(ordinance ~ avg_cap, data =  turbine_ordinance_county[train, ], family = binomial(link = "logit"))
data_train$logit_pred <- predict(logit, turbine_ordinance_county[train, ], type = "response")

probit <- glm(ordinance ~ avg_cap, data =  turbine_ordinance_county[train, ], family = binomial(link = "probit"))
data_train$probit_pred <- predict(probit, turbine_ordinance_county[train, ], type = "response")
```
regression coefficients:
```{r}
coeff_table <- matrix(data = NA, nrow = 2, ncol=4)
coeff_table[,1] <- names(lpm$coefficients)
coeff_table[,2] <- round(lpm$coefficients, 3)
coeff_table[,3] <- round(probit$coefficients, 3)
coeff_table[,4] <- round(logit$coefficients, 3)
colnames(coeff_table) <- c("","LPM","Probit","Logit")
coeff_table
```
SVM with gaussian kernel
```{r}
data_train <- turbine_ordinance_county[train, c("ordinance", "avg_cap", "avg_rd")]
data_train$ordinance <- as.factor(ifelse(data_train$ordinance == 0, -1, 1))

tune.out <- tune(svm, ordinance ~  ., data = data_train, kernel="radial", scale = TRUE, gamma = 0.01, 
              ranges = list(cost = c(1, 10, 100, 10^3, 10^4)))

svm.pred <- predict(tune.out$best.model, newdata = turbine_ordinance_county[test, c("avg_cap", "avg_rd")])
svm.pred <- ifelse(svm.pred == -1 , 0 , 1)
```
predict the binary response for test data
```{r}
test_lpm <- mean((predict(lpm,  turbine_ordinance_county[test, ]) >= .5) != y_test)

test_logit <- mean((predict(logit, turbine_ordinance_county[test, ], type = "response") >= .5) != y_test)

test_probit <- mean((predict(probit, turbine_ordinance_county[test, ], type = "response") >= .5) != y_test)

test_svm <- mean(svm.pred != y_test)
```
Table
```{r}
mse_table <- matrix(data = NA, nrow = 4, ncol=2)
mse_table[,1] <- c("LPM", "Logit", "Probit", "SVM")
mse_table[,2] <- round(rbind(test_lpm, test_logit, test_probit, test_svm), 3)
mse_table
```
LPM, logit, probit, More Vers
```{r}
lpm <- lm(ordinance ~ avg_cap + tot_cap + avg_hh + avg_rd, data =  turbine_ordinance_county[train, ])
data_train$lpm_prediction <- predict(lpm,  turbine_ordinance_county[train, ])

logit <- glm(ordinance ~ avg_cap + tot_cap + avg_hh + avg_rd, data =  turbine_ordinance_county[train, ], family = binomial(link = "logit"))
data_train$logit_pred <- predict(logit, turbine_ordinance_county[train, ], type = "response")

probit <- glm(ordinance ~ avg_cap + tot_cap + avg_hh + avg_rd, data =  turbine_ordinance_county[train, ], family = binomial(link = "probit"))
data_train$probit_pred <- predict(probit, turbine_ordinance_county[train, ], type = "response")
```
predict the binary response for test data More Vers
```{r}
test_lpm <- mean((predict(lpm,  turbine_ordinance_county[test, ]) >= .5) != y_test)

test_logit <- mean((predict(logit, turbine_ordinance_county[test, ], type = "response") >= .5) != y_test)

test_probit <- mean((predict(probit, turbine_ordinance_county[test, ], type = "response") >= .5) != y_test)
```
Table More Vers
```{r}
mse_table <- matrix(data = NA, nrow = 3, ncol=2)
mse_table[,1] <- c("LPM", "Logit", "Probit")
mse_table[,2] <- round(rbind(test_lpm, test_logit, test_probit), 3)
mse_table
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

